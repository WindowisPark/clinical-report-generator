{{SCHEMA_CONTEXT}}

{{EXAMPLES}}

{{DATABRICKS_RULES}}

## 주요 테이블 스키마 요약

### basic_treatment 테이블
- `user_id` (STRING): 사용자 ID
- `res_hospital_name` (STRING): 병원명 (지역 필터링 가능, 예: LIKE '%서울%')
- `res_hospital_code` (STRING): 병원 코드
- `company_identity` (STRING): 사업자번호
- `res_disease_name` (STRING): 질환명
- `res_treat_start_date` (CHAR(200)): 치료 시작일 ('YYYYMMDD' 형식)
- `deleted` (BOOLEAN): 삭제 여부
- **중요**: 지역 정보는 `res_hospital_name`에서 LIKE로 추출

### insured_person 테이블
- `user_id` (STRING): 사용자 ID
- `gender` (STRING): 성별 (MAN=남성, WOMAN=여성)
- `birthday` (CHAR(8)): 생년월일 ('YYYYMMDD' 형식, 예: '19860324')
- **중요**: 연령 계산 시 `YEAR(CURRENT_DATE) - YEAR(TO_DATE(birthday, 'yyyyMMdd'))`

### prescribed_drug 테이블
- `user_id` (STRING): 사용자 ID
- `res_drug_name` (STRING): 약물명
- `res_ingredients` (STRING): 성분명
- `res_treat_start_date` (CHAR(200)): 처방 시작일
- `deleted` (BOOLEAN): 삭제 여부

### hospital 테이블
- `company_identity` (STRING): 사업자번호
- `name` (STRING): 병원명
- `address` (STRING): 주소
- **참고**: 대부분의 경우 조인보다 `basic_treatment.res_hospital_name` 사용 권장

## SQL 작성 체크리스트

쿼리를 작성하기 전에 다음을 확인하세요:

- [ ] 날짜 필드 변환에 `TO_DATE(field, 'yyyyMMdd')` 사용했는가?
- [ ] basic_treatment/prescribed_drug 사용 시 `WHERE deleted = FALSE` 포함했는가?
- [ ] 정규식에 `RLIKE` 사용했는가? (REGEXP 아님)
- [ ] 타입 변환에 `CAST AS INTEGER` 사용했는가? (INT 아님)
- [ ] 성별 코드를 MAN/WOMAN으로 사용했는가?
- [ ] 개인정보(이름, 전화번호)를 마스킹했는가?
- [ ] 조인 키가 정확한가? (user_id, res_treat_start_date, company_identity)
- [ ] 병원 등급 분류 시 res_hospital_name LIKE 패턴을 사용했는가?

## 사용자 요청

```
{{USER_QUERY}}
```

## 작업 지시사항

위 요청을 분석하여 다음을 수행하세요:

1. **의도 파악**: 사용자가 원하는 정보가 무엇인지 명확히 식별
2. **테이블 선택**: 필요한 테이블과 컬럼을 스키마에서 확인
3. **조인 전략**: 여러 테이블이 필요한 경우 최적의 조인 방법 결정
4. **조건 설정**: 필터링, 집계, 정렬 조건 정의
5. **쿼리 작성**: Spark SQL 문법에 맞게 완전한 쿼리 생성
6. **검증**: 위 체크리스트로 최종 확인

{{OUTPUT_VALIDATION}}

## 출력 형식

JSON만 반환하세요 (코드 블록이나 설명 없이):

```json
{
  "analysis": {
    "intent": "사용자 요청의 의도를 한 문장으로",
    "required_tables": ["사용할 테이블 목록"],
    "key_conditions": ["주요 WHERE 조건", "조인 조건 등"],
    "join_strategy": "조인 전략 설명 (조인이 있는 경우)"
  },
  "sql": "-- 주석\nSELECT ...\nFROM ...\nWHERE ...\nGROUP BY ...\nORDER BY ...\nLIMIT ...",
  "explanation": "쿼리가 요청을 어떻게 해결하는지 한글로 설명 (2-3문장)"
}
```

**예시:**
```json
{
  "analysis": {
    "intent": "고혈압 환자의 연령대별 분포 조회",
    "required_tables": ["basic_treatment", "insured_person"],
    "key_conditions": ["질환명 = 고혈압", "deleted = FALSE", "연령 계산"],
    "join_strategy": "user_id로 basic_treatment와 insured_person 조인"
  },
  "sql": "-- 고혈압 환자의 연령대별 분포\nSELECT\n  CASE\n    WHEN YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) < 30 THEN '20대 이하'\n    WHEN YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) < 40 THEN '30대'\n    WHEN YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) < 50 THEN '40대'\n    WHEN YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) < 60 THEN '50대'\n    ELSE '60대 이상'\n  END AS age_group,\n  COUNT(DISTINCT bt.user_id) AS patient_count\nFROM basic_treatment bt\nJOIN insured_person ip ON bt.user_id = ip.user_id\nWHERE bt.res_disease_name LIKE '%고혈압%'\n  AND bt.deleted = FALSE\nGROUP BY age_group\nORDER BY age_group",
  "explanation": "basic_treatment에서 고혈압 환자를 필터링하고, insured_person 테이블과 조인하여 생년월일을 가져옵니다. birthday는 CHAR 타입이므로 TO_DATE() 변환 후 현재 연도와의 차이로 연령을 계산하고, CASE 문으로 연령대를 구분하여 환자 수를 집계합니다."
}
```

## 중요 알림

- **순수 JSON만 반환**: Markdown 코드 블록(```) 없이 JSON 객체만 출력
- **SQL 내 줄바꿈**: JSON 문자열 내에서 `\n`로 표현
- **이스케이프**: SQL 내 큰따옴표는 `\"` 또는 작은따옴표 사용
