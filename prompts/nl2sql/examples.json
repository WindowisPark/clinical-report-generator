[
  {
    "question": "고혈압 환자의 성별, 연령대별 분포를 알려줘",
    "sql": "SELECT\n  ip.gender,\n  CASE\n    WHEN YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) < 30 THEN '20대 이하'\n    WHEN YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) < 40 THEN '30대'\n    WHEN YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) < 50 THEN '40대'\n    WHEN YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) < 60 THEN '50대'\n    ELSE '60대 이상'\n  END AS age_group,\n  COUNT(DISTINCT bt.user_id) AS patient_count\nFROM basic_treatment bt\nJOIN insured_person ip ON bt.user_id = ip.user_id\nWHERE bt.res_disease_name LIKE '%고혈압%'\n  AND bt.deleted = FALSE\nGROUP BY ip.gender, age_group\nORDER BY ip.gender, age_group",
    "explanation": "basic_treatment와 insured_person을 조인하여 고혈압 환자의 성별과 연령대별 분포를 계산합니다. birthday는 CHAR 타입이므로 TO_DATE() 변환이 필수입니다."
  },
  {
    "question": "서울 지역 당뇨병 환자에게 처방된 상위 10개 약물은?",
    "sql": "SELECT\n  pd.res_drug_name,\n  COUNT(DISTINCT pd.user_id) AS patient_count,\n  COUNT(*) AS prescription_count\nFROM basic_treatment bt\nJOIN prescribed_drug pd \n  ON bt.user_id = pd.user_id \n  AND bt.res_treat_start_date = pd.res_treat_start_date\nWHERE bt.res_disease_name LIKE '%당뇨%'\n  AND bt.res_hospital_name LIKE '%서울%'\n  AND bt.deleted = FALSE\n  AND pd.deleted = FALSE\nGROUP BY pd.res_drug_name\nORDER BY patient_count DESC\nLIMIT 10",
    "explanation": "basic_treatment의 res_hospital_name에서 '서울'을 필터링하여 지역을 특정하고, prescribed_drug와 조인하여 약물 처방 정보를 집계합니다. user_id와 res_treat_start_date를 모두 조인 키로 사용했습니다."
  },
  {
    "question": "최근 1년간 천식으로 병원을 방문한 40대 여성 환자 수는?",
    "sql": "SELECT\n  COUNT(DISTINCT bt.user_id) AS patient_count\nFROM basic_treatment bt\nJOIN insured_person ip ON bt.user_id = ip.user_id\nWHERE bt.res_disease_name LIKE '%천식%'\n  AND TO_DATE(bt.res_treat_start_date, 'yyyyMMdd') >= DATE_SUB(CURRENT_DATE, 365)\n  AND YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) BETWEEN 40 AND 49\n  AND ip.gender = 'WOMAN'\n  AND bt.deleted = FALSE",
    "explanation": "res_treat_start_date를 TO_DATE()로 변환하여 최근 1년 필터링을 적용하고, birthday로 연령을 계산하여 40대를 필터링합니다. 두 날짜 필드 모두 CHAR 타입이므로 변환이 필수입니다."
  },
  {
    "question": "병원 등급별 알레르기 비염 환자 분포",
    "sql": "SELECT\n  CASE\n    WHEN res_hospital_name LIKE '%대학교%' OR res_hospital_name LIKE '%의료원%' THEN '3차 의료기관'\n    WHEN res_hospital_name LIKE '%병원%' THEN '2차 의료기관'\n    WHEN res_hospital_name LIKE '%의원%' THEN '1차 의료기관'\n    ELSE '기타'\n  END AS hospital_tier,\n  COUNT(DISTINCT user_id) AS patient_count,\n  COUNT(*) AS visit_count\nFROM basic_treatment\nWHERE res_disease_name LIKE '%알레르기%' AND res_disease_name LIKE '%비염%'\n  AND deleted = FALSE\nGROUP BY hospital_tier\nORDER BY patient_count DESC",
    "explanation": "hospital 테이블 조인 대신 res_hospital_name을 LIKE 패턴으로 분석하여 병원 등급을 분류합니다. 이 방법이 더 효율적이고 정확합니다."
  },
  {
    "question": "고혈압 환자 중 최근 3년간 처방 이력이 있는 환자의 평균 연령",
    "sql": "SELECT\n  AVG(YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd'))) AS avg_age,\n  COUNT(DISTINCT bt.user_id) AS patient_count\nFROM basic_treatment bt\nJOIN insured_person ip ON bt.user_id = ip.user_id\nJOIN prescribed_drug pd \n  ON bt.user_id = pd.user_id \n  AND bt.res_treat_start_date = pd.res_treat_start_date\nWHERE bt.res_disease_name LIKE '%고혈압%'\n  AND TO_DATE(pd.res_treat_start_date, 'yyyyMMdd') >= DATE_SUB(CURRENT_DATE, 1095)\n  AND bt.deleted = FALSE\n  AND pd.deleted = FALSE",
    "explanation": "basic_treatment, insured_person, prescribed_drug 3개 테이블을 조인하여 고혈압 환자 중 최근 3년간(1095일) 처방 이력이 있는 환자의 평균 연령을 계산합니다. birthday와 res_treat_start_date 모두 TO_DATE() 변환을 사용했습니다."
  },
  {
    "question": "부산 지역 3차 병원에서 폐렴 치료받은 60대 이상 남성 환자의 이름과 연락처 (개인정보 마스킹 필수)",
    "sql": "SELECT\n  CONCAT(LEFT(ip.name, 1), '**') AS masked_name,\n  CONCAT('***-****-', RIGHT(ip.phone_number, 4)) AS masked_phone,\n  YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) AS age,\n  bt.res_hospital_name\nFROM basic_treatment bt\nJOIN insured_person ip ON bt.user_id = ip.user_id\nWHERE bt.res_disease_name LIKE '%폐렴%'\n  AND bt.res_hospital_name LIKE '%부산%'\n  AND (bt.res_hospital_name LIKE '%대학교%' OR bt.res_hospital_name LIKE '%의료원%')\n  AND YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) >= 60\n  AND ip.gender = 'MAN'\n  AND bt.deleted = FALSE\nLIMIT 100",
    "explanation": "개인정보 보호를 위해 이름은 첫 글자만, 전화번호는 뒤 4자리만 표시합니다. 지역과 병원 등급은 res_hospital_name의 LIKE 패턴으로 필터링하고, 연령은 birthday를 TO_DATE() 변환하여 계산합니다."
  },
  {
    "question": "아토피 환자의 월별 병원 방문 추이 (최근 2년)",
    "sql": "SELECT\n  YEAR(TO_DATE(res_treat_start_date, 'yyyyMMdd')) AS visit_year,\n  MONTH(TO_DATE(res_treat_start_date, 'yyyyMMdd')) AS visit_month,\n  COUNT(DISTINCT user_id) AS unique_patients,\n  COUNT(*) AS total_visits\nFROM basic_treatment\nWHERE res_disease_name LIKE '%아토피%'\n  AND TO_DATE(res_treat_start_date, 'yyyyMMdd') >= DATE_SUB(CURRENT_DATE, 730)\n  AND deleted = FALSE\nGROUP BY visit_year, visit_month\nORDER BY visit_year, visit_month",
    "explanation": "res_treat_start_date를 TO_DATE()로 변환하여 연도와 월을 추출하고, 최근 2년간(730일) 데이터를 필터링합니다. 월별 고유 환자 수와 총 방문 횟수를 집계하여 계절성 분석이 가능합니다."
  }
]
