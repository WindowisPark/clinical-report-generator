## RAG 스키마 정보 활용 가이드

### 스키마 정보 해석 방법
프롬프트에 제공되는 데이터베이스 스키마 정보는 사용자 쿼리와 관련된 테이블 및 컬럼만 포함합니다.

**제공 형식:**
```
테이블명: basic_treatment
- 컬럼명: user_id (타입: STRING) - 사용자 고유 ID
- 컬럼명: res_disease_name (타입: STRING) - 질환명
- 컬럼명: res_treat_start_date (타입: CHAR(200)) - 치료 시작일 YYYYMMDD 형식
...
```

### 스키마 활용 원칙

1. **가용 데이터 우선**
   - 스키마에 명시된 컬럼만 사용
   - 스키마에 없는 컬럼은 사용하지 않음
   - 불확실한 경우 가장 유사한 컬럼 선택 후 설명에 명시

2. **타입 인식**
   - CHAR/STRING 타입: 문자열 비교 시 TO_DATE() 변환 확인
   - INTEGER/BIGINT: 숫자 연산 가능
   - BOOLEAN: TRUE/FALSE 비교
   - DATE: 직접 날짜 연산 가능 (단, 대부분의 날짜는 CHAR 타입임)

3. **테이블 관계 파악**
   - 여러 테이블의 스키마가 제공되면 조인 가능
   - 조인 키는 일반적으로 user_id, company_identity
   - 시간 정보가 있으면 res_treat_start_date도 조인 키로 사용 가능

4. **질환 필터링 주의사항**
   - 질환은 **반드시 res_disease_name으로 필터링**
   - 질환 코드(disease_code)가 아닌 질환명(한글)으로 검색
   - 예: `WHERE res_disease_name LIKE '%고혈압%'`

### 스키마 정보가 불충분한 경우

스키마 정보만으로 요청을 완전히 처리할 수 없는 경우:

1. **추론 가능한 경우**
   - 일반적인 데이터베이스 설계 패턴 활용
   - 설명에 가정 사항 명시
   - 예: "user_id를 조인 키로 사용했습니다 (표준 관례)"

2. **추론 불가능한 경우**
   - 응답에 제한사항 명시
   - 대안 제시
   - 예: "제공된 스키마에 '지역' 정보가 없어 res_hospital_name을 활용했습니다"

### 예시: 스키마 기반 쿼리 작성

**제공된 스키마:**
```
테이블: basic_treatment
- user_id, res_disease_name, res_treat_start_date, res_hospital_name

테이블: insured_person
- user_id, gender, birthday
```

**사용자 요청:** "고혈압 환자의 연령대별 분포"

**올바른 접근:**
```sql
SELECT
  CASE
    WHEN YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) < 30 THEN '20대 이하'
    WHEN YEAR(CURRENT_DATE) - YEAR(TO_DATE(ip.birthday, 'yyyyMMdd')) < 40 THEN '30대'
    ...
  END AS age_group,
  COUNT(DISTINCT bt.user_id) AS patient_count
FROM basic_treatment bt
JOIN insured_person ip ON bt.user_id = ip.user_id
WHERE bt.res_disease_name LIKE '%고혈압%'
  AND bt.deleted = FALSE
GROUP BY age_group
```

**설명 포함:**
- basic_treatment의 user_id와 insured_person의 user_id를 조인
- birthday는 CHAR 타입이므로 TO_DATE() 변환 후 연령 계산
- 질환은 res_disease_name으로 필터링 (LIKE 사용)
