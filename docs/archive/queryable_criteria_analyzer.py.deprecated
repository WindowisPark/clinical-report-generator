"""
ì„ìƒì‹œí—˜ ì„ ì •/ì œì™¸ ê¸°ì¤€ì—ì„œ ì¿¼ë¦¬ ê²€ì¦ ê°€ëŠ¥ì„± ë¶„ì„ ì‹œìŠ¤í…œ (LLM ê¸°ë°˜)
"""

import pandas as pd
import os
import json
import re
import yaml
from typing import Dict, List, Optional, Any, Tuple
from dataclasses import dataclass
from enum import Enum
import google.generativeai as genai


class QueryabilityLevel(Enum):
    """ì¿¼ë¦¬ ê²€ì¦ ê°€ëŠ¥ì„± ìˆ˜ì¤€"""
    HIGH = "HIGH"        # 80%+ ê²€ì¦ê°€ëŠ¥
    MEDIUM = "MEDIUM"    # 40-80% ê²€ì¦ê°€ëŠ¥
    LOW = "LOW"          # 40% ë¯¸ë§Œ


@dataclass
class QueryableCriteriaResult:
    """ì¿¼ë¦¬ ê°€ëŠ¥ì„± ë¶„ì„ ê²°ê³¼"""
    original_text: str                    # ì›ë³¸ ê¸°ì¤€ í…ìŠ¤íŠ¸
    overall_queryability: QueryabilityLevel  # ì „ì²´ ì¿¼ë¦¬ ê°€ëŠ¥ì„±
    queryable_parts: List[str]           # ì¿¼ë¦¬ë¡œ ê²€ì¦ ê°€ëŠ¥í•œ ë¶€ë¶„ë“¤
    non_queryable_parts: List[str]       # ì¿¼ë¦¬ë¡œ ê²€ì¦ ë¶ˆê°€ëŠ¥í•œ ë¶€ë¶„ë“¤
    required_tables: List[str]           # í•„ìš”í•œ ë°ì´í„°ë¸Œë¦­ìŠ¤ í…Œì´ë¸”ë“¤
    suggested_query_approach: str        # ì œì•ˆëœ ì¿¼ë¦¬ ì ‘ê·¼ë²•
    recommended_recipes: List[str]       # í™œìš© ê°€ëŠ¥í•œ ê¸°ì¡´ ë ˆì‹œí”¼ë“¤
    data_limitations: List[str]          # ë°ì´í„° ì œì•½ì‚¬í•­ë“¤
    confidence_score: float              # LLM ë¶„ì„ ì‹ ë¢°ë„ (0-1)
    practical_notes: str                 # ì‹¤ë¬´ì§„ì„ ìœ„í•œ ì¶”ê°€ ê³ ë ¤ì‚¬í•­


class QueryableCriteriaAnalyzer:
    """ì„ìƒì‹œí—˜ ê¸°ì¤€ì˜ ë°ì´í„°ë¸Œë¦­ìŠ¤ ì¿¼ë¦¬ ê²€ì¦ ê°€ëŠ¥ì„± ë¶„ì„ê¸° (LLM ê¸°ë°˜)"""

    def __init__(self):
        self.llm_model = None
        self._setup_llm()
        self.databricks_context = self._create_databricks_context()

    def _setup_llm(self):
        """LLM ì„¤ì •"""
        try:
            # 1. í™˜ê²½ë³€ìˆ˜ì—ì„œ API í‚¤ í™•ì¸
            api_key = os.getenv('GEMINI_API_KEY')

            # 2. config.yamlì—ì„œ API í‚¤ í™•ì¸ (í™˜ê²½ë³€ìˆ˜ê°€ ì—†ìœ¼ë©´)
            if not api_key:
                try:
                    config_path = "config.yaml"
                    if os.path.exists(config_path):
                        with open(config_path, "r", encoding="utf-8") as f:
                            config = yaml.safe_load(f)
                            api_key = config.get("api_keys", {}).get("gemini_api_key")
                except Exception as e:
                    print(f"âš ï¸ config.yaml ì½ê¸° ì‹¤íŒ¨: {e}")

            if api_key and api_key != "YOUR_GEMINI_API_KEY_HERE":
                genai.configure(api_key=api_key)
                self.llm_model = genai.GenerativeModel('gemini-2.5-flash')
                print("âœ… LLM (Gemini) ì„¤ì • ì™„ë£Œ (gemini-2.5-flash)")
            else:
                print("âš ï¸ GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ")
                raise Exception("LLM API í‚¤ í•„ìš”")
        except Exception as e:
            print(f"âš ï¸ LLM ì„¤ì • ì‹¤íŒ¨: {e}")
            raise

    def _create_databricks_context(self) -> str:
        """ë°ì´í„°ë¸Œë¦­ìŠ¤ ìŠ¤í‚¤ë§ˆ ì»¨í…ìŠ¤íŠ¸ ìƒì„±"""

        context = """
# ë°ì´í„°ë¸Œë¦­ìŠ¤ í—¬ìŠ¤ì¼€ì–´ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì •ë³´

## ğŸ¥ ì£¼ìš” í…Œì´ë¸” ë° í™œìš© ê°€ëŠ¥ ë°ì´í„°

### 1. í™˜ì ê¸°ë³¸ ì •ë³´
- **user**: ì‚¬ìš©ì ê¸°ë³¸ì •ë³´ (ê°€ì…ì¼, ê¸°ë³¸ ì„¤ì •)
- **insured_person**: í”¼ë³´í—˜ì ì •ë³´ (ìƒë…„ì›”ì¼, ì„±ë³„, ê°€ì¡±ê´€ê³„)

### 2. ì§„ë£Œ ë° ì¹˜ë£Œ ê¸°ë¡
- **basic_treatment**: ê¸°ë³¸ ì§„ë£Œ ê¸°ë¡
  * res_disease_name: ì§„ë‹¨ëª…/ì§ˆí™˜ëª…
  * res_hospital_name: ë³‘ì›ëª…
  * res_treat_start_date: ì¹˜ë£Œ ì‹œì‘ì¼
  * res_hospital_code: ë³‘ì› ì½”ë“œ

- **detail_treatment**: ìƒì„¸ ì§„ë£Œ/ì‹œìˆ  ê¸°ë¡
  * ì˜ë£Œ í–‰ìœ„, ì²˜ì¹˜, ìˆ˜ìˆ  ë“±ì˜ ìƒì„¸ ì •ë³´

### 3. ì²˜ë°© ë° ì•½ë¬¼
- **prescribed_drug**: ì²˜ë°© ì•½ë¬¼ ê¸°ë¡
  * res_drug_name: ì•½ë¬¼ëª…
  * res_ingredients: ì„±ë¶„ëª…
  * res_total_dosing_days: ì´ íˆ¬ì•½ì¼ìˆ˜
  * res_treat_start_date: ì²˜ë°©ì¼

### 4. ë³‘ì› ë° ì˜ë£Œê¸°ê´€
- **hospital**: ë³‘ì› ì •ë³´
  * name: ë³‘ì›ëª…
  * medical_facility_type_code: ì˜ë£Œê¸°ê´€ ì¢…ë¥˜
  * sido_name: ì§€ì—­ ì •ë³´

### 5. ì˜ë£Œë¹„ ë° ë³´í—˜
- **medical_expenses_detail_history**: ì˜ë£Œë¹„ ìƒì„¸ ë‚´ì—­
- **insurance_payment**: ë³´í—˜ ì§€ê¸‰ ì •ë³´

### 6. ê±´ê°•ê²€ì§„
- **nhis_health_checkup_result**: êµ­ë¯¼ê±´ê°•ë³´í—˜ ê±´ê°•ê²€ì§„ ê²°ê³¼
  * ì‹ ì²´ ì¸¡ì •, í˜ˆì•¡ê²€ì‚¬, ì†Œë³€ê²€ì‚¬ ë“±ì˜ ì‹¤ì œ ê²€ì‚¬ ê²°ê³¼ê°’ í¬í•¨ ê°€ëŠ¥

## ğŸ” ì¿¼ë¦¬ ê²€ì¦ ê°€ëŠ¥ì„± íŒë‹¨ ê¸°ì¤€

### âœ… HIGH (80%+ ê²€ì¦ê°€ëŠ¥)
- ì—°ë ¹, ì„±ë³„ (insured_person.birthday, gender)
- ì§„ë‹¨/ì§ˆí™˜ ì´ë ¥ (basic_treatment.res_disease_name)
- ì²˜ë°© ì•½ë¬¼ ì´ë ¥ (prescribed_drug.res_drug_name, res_ingredients)
- ë³‘ì› ë°©ë¬¸ ì´ë ¥ (basic_treatment)
- ì¹˜ë£Œ ê¸°ê°„/ë‚ ì§œ (res_treat_start_date)

### ğŸ”¶ MEDIUM (40-80% ê²€ì¦ê°€ëŠ¥)
- ê±´ê°•ê²€ì§„ ìˆ˜ì¹˜ (nhis_health_checkup_result) - ë°ì´í„° ì¡´ì¬ì‹œ
- ì˜ë£Œë¹„ ì§€ì¶œ íŒ¨í„´ (medical_expenses_detail_history)
- íŠ¹ì • ì‹œìˆ /ìˆ˜ìˆ  ì´ë ¥ (detail_treatment)

### âŒ LOW (40% ë¯¸ë§Œ)
- ì‹¤ì‹œê°„ ë°”ì´íƒˆ ì‚¬ì¸ (í˜ˆì••, ë§¥ë°• ë“±)
- ìƒí™œìŠµê´€ (í¡ì—°, ìŒì£¼, ìš´ë™)
- ì£¼ê´€ì  ì¦ìƒì´ë‚˜ í™˜ì ìƒíƒœ
- ì˜ë£Œì§„ì˜ ì„ìƒì  íŒë‹¨ì´ í•„ìš”í•œ í•­ëª©
- ì—°êµ¬ ì°¸ì—¬ ì˜ì§€, ë™ì˜ ëŠ¥ë ¥ ë“±

## ğŸ’¡ ê¶Œì¥ ì¿¼ë¦¬ ì ‘ê·¼ë²•
1. **í™˜ì í’€ ìŠ¤í¬ë¦¬ë‹**: basic_treatment + insured_person JOIN
2. **ì•½ë¬¼ ê¸°ì¤€ ê²€ì¦**: prescribed_drug í…Œì´ë¸” í™œìš©
3. **ì‹œê°„ì  ê¸°ì¤€**: res_treat_start_date ê¸°ë°˜ í•„í„°ë§
4. **ì§€ì—­/ë³‘ì› ê¸°ì¤€**: hospital í…Œì´ë¸”ê³¼ JOIN

## ğŸ”§ í™œìš© ê°€ëŠ¥í•œ ê¸°ì¡´ ë ˆì‹œí”¼ë“¤
- screen_patients_by_clinical_criteria: ì„ìƒ ê¸°ì¤€ í™˜ì ìŠ¤í¬ë¦¬ë‹
- analyze_screened_patient_count: ìŠ¤í¬ë¦¬ë‹ëœ í™˜ì ìˆ˜ ì§‘ê³„
- analyze_screened_gender_distribution: ì„±ë³„ ë¶„í¬ ë¶„ì„
- analyze_screened_regional_distribution: ì§€ì—­ ë¶„í¬ ë¶„ì„
- get_top_prescribed_ingredients_by_disease: ì§ˆí™˜ë³„ ì²˜ë°© ì•½ë¬¼
- analyze_medication_adherence_mpr: ë³µì•½ìˆœì‘ë„ ë¶„ì„
- extract_patients_by_age_gender: ì—°ë ¹/ì„±ë³„ í™˜ì ì¶”ì¶œ
- extract_patients_by_medication_history: ì•½ë¬¼ ì´ë ¥ í™˜ì ì¶”ì¶œ
- extract_patients_by_diagnosis_period: ì§„ë‹¨ ê¸°ê°„ í™˜ì ì¶”ì¶œ
"""
        return context

    def analyze_single_criteria(self, criteria_text: str, trial_name: str = "") -> QueryableCriteriaResult:
        """ë‹¨ì¼ ì„ìƒì‹œí—˜ ê¸°ì¤€ì˜ ì¿¼ë¦¬ ê°€ëŠ¥ì„± ë¶„ì„"""

        print(f"ğŸ” ì„ìƒì‹œí—˜ ê¸°ì¤€ ë¶„ì„ ì¤‘: {criteria_text[:50]}...")

        if not self.llm_model:
            raise Exception("LLM ëª¨ë¸ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")

        prompt = f"""
{self.databricks_context}

ë‹¹ì‹ ì€ í—¬ìŠ¤ì¼€ì–´ ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ìœ„ì˜ ë°ì´í„°ë¸Œë¦­ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì°¸ê³ í•˜ì—¬ ë‹¤ìŒ ì„ìƒì‹œí—˜ ê¸°ì¤€ì´ ì¿¼ë¦¬ë¡œ ê²€ì¦ ê°€ëŠ¥í•œì§€ ë¶„ì„í•´ì£¼ì„¸ìš”.

## ğŸ“‹ ë¶„ì„ ëŒ€ìƒ
**ì„ìƒì‹œí—˜ëª…**: {trial_name}
**ê¸°ì¤€ ë‚´ìš©**: {criteria_text}

## ğŸ“Š ìš”ì²­ ë¶„ì„ ë‚´ìš©

1. **ì¿¼ë¦¬ ê²€ì¦ ê°€ëŠ¥ì„± ë¶„ë¥˜**:
   - HIGH (80%+ ê²€ì¦ê°€ëŠ¥): ë°ì´í„°ë¸Œë¦­ìŠ¤ë¡œ ì •í™•íˆ í™•ì¸ ê°€ëŠ¥
   - MEDIUM (40-80% ê²€ì¦ê°€ëŠ¥): ë¶€ë¶„ì ìœ¼ë¡œë§Œ í™•ì¸ ê°€ëŠ¥
   - LOW (40% ë¯¸ë§Œ): í˜„ì¬ ë°ì´í„°ë¡œëŠ” ê²€ì¦ ì–´ë ¤ì›€

2. **êµ¬ì²´ì  ë¶„ì„**:
   - ì–´ë–¤ í…Œì´ë¸”/ì»¬ëŸ¼ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ì§€
   - ì˜ˆìƒ ì¿¼ë¦¬ ì ‘ê·¼ë²•
   - ë°ì´í„° ì œì•½ì‚¬í•­ì´ë‚˜ í•œê³„ì 

3. **ì‹¤í–‰ ê°€ëŠ¥í•œ ë ˆì‹œí”¼ ì¶”ì²œ**:
   - ê¸°ì¡´ ë ˆì‹œí”¼ ì¤‘ í™œìš© ê°€ëŠ¥í•œ ê²ƒë“¤
   - ìƒˆë¡œ í•„ìš”í•œ ì¿¼ë¦¬ ë¡œì§

ë‹¤ìŒ JSON í˜•íƒœë¡œ ì •í™•íˆ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{{
    "overall_queryability": "HIGH|MEDIUM|LOW",
    "queryable_parts": ["ê²€ì¦ ê°€ëŠ¥í•œ êµ¬ì²´ì  ë¶€ë¶„ë“¤"],
    "non_queryable_parts": ["ê²€ì¦ ì–´ë ¤ìš´ ë¶€ë¶„ë“¤ê³¼ ì´ìœ "],
    "required_tables": ["í•„ìš”í•œ í…Œì´ë¸”ëª…ë“¤"],
    "suggested_query_approach": "êµ¬ì²´ì ì¸ ì¿¼ë¦¬ ì ‘ê·¼ ë°©ë²•",
    "recommended_recipes": ["í™œìš© ê°€ëŠ¥í•œ ê¸°ì¡´ ë ˆì‹œí”¼ë“¤"],
    "data_limitations": ["ë°ì´í„° ì œì•½ì‚¬í•­ë“¤"],
    "confidence_score": 0.85,
    "practical_notes": "ì‹¤ë¬´ì§„ì„ ìœ„í•œ ì¶”ê°€ ê³ ë ¤ì‚¬í•­"
}}
"""

        try:
            response = self.llm_model.generate_content(prompt)
            result_data = self._parse_llm_response(response.text)

            return QueryableCriteriaResult(
                original_text=criteria_text,
                overall_queryability=QueryabilityLevel(result_data.get("overall_queryability", "LOW")),
                queryable_parts=result_data.get("queryable_parts", []),
                non_queryable_parts=result_data.get("non_queryable_parts", []),
                required_tables=result_data.get("required_tables", []),
                suggested_query_approach=result_data.get("suggested_query_approach", ""),
                recommended_recipes=result_data.get("recommended_recipes", []),
                data_limitations=result_data.get("data_limitations", []),
                confidence_score=float(result_data.get("confidence_score", 0.5)),
                practical_notes=result_data.get("practical_notes", "")
            )

        except Exception as e:
            print(f"    âš ï¸ LLM ë¶„ì„ ì‹¤íŒ¨: {e}")
            # ë°±ì—…ìœ¼ë¡œ ê¸°ë³¸ ê²°ê³¼ ë°˜í™˜
            return QueryableCriteriaResult(
                original_text=criteria_text,
                overall_queryability=QueryabilityLevel.LOW,
                queryable_parts=[],
                non_queryable_parts=["LLM ë¶„ì„ ì‹¤íŒ¨ë¡œ ì¸í•œ ë¯¸ë¶„ë¥˜"],
                required_tables=[],
                suggested_query_approach="ìˆ˜ë™ ê²€í†  í•„ìš”",
                recommended_recipes=[],
                data_limitations=["LLM ë¶„ì„ ì˜¤ë¥˜"],
                confidence_score=0.0,
                practical_notes="ìˆ˜ë™ìœ¼ë¡œ ì¬ê²€í†  í•„ìš”"
            )

    def analyze_trial_criteria(self, trial_name: str, inclusion_criteria: str, exclusion_criteria: str) -> Dict[str, Any]:
        """ì„ìƒì‹œí—˜ ì „ì²´ ê¸°ì¤€ ë¶„ì„ (ì„ ì •/ì œì™¸ ê¸°ì¤€)"""

        print(f"\nğŸ¥ ì„ìƒì‹œí—˜ ê¸°ì¤€ ì¢…í•© ë¶„ì„: {trial_name}")
        print("=" * 60)

        # ì„ ì • ê¸°ì¤€ì„ ì¤„ë³„ë¡œ ë¶„ì„
        inclusion_lines = [line.strip() for line in inclusion_criteria.strip().split('\n')
                          if line.strip() and not line.strip().startswith(('#', '//', '-', 'â€¢'))]

        # ì œì™¸ ê¸°ì¤€ì„ ì¤„ë³„ë¡œ ë¶„ì„
        exclusion_lines = [line.strip() for line in exclusion_criteria.strip().split('\n')
                          if line.strip() and not line.strip().startswith(('#', '//', '-', 'â€¢'))]

        print(f"ğŸ“‹ ì„ ì • ê¸°ì¤€ {len(inclusion_lines)}ê°œ ë¶„ì„ ì¤‘...")
        inclusion_results = []
        for i, line in enumerate(inclusion_lines, 1):
            print(f"  {i}. {line[:80]}...")
            result = self.analyze_single_criteria(line, trial_name)
            inclusion_results.append(result)

        print(f"\nğŸš« ì œì™¸ ê¸°ì¤€ {len(exclusion_lines)}ê°œ ë¶„ì„ ì¤‘...")
        exclusion_results = []
        for i, line in enumerate(exclusion_lines, 1):
            print(f"  {i}. {line[:80]}...")
            result = self.analyze_single_criteria(line, trial_name)
            exclusion_results.append(result)

        # ì „ì²´ ìš”ì•½ í†µê³„
        all_results = inclusion_results + exclusion_results
        total_criteria = len(all_results)

        queryability_counts = {
            QueryabilityLevel.HIGH: sum(1 for r in all_results if r.overall_queryability == QueryabilityLevel.HIGH),
            QueryabilityLevel.MEDIUM: sum(1 for r in all_results if r.overall_queryability == QueryabilityLevel.MEDIUM),
            QueryabilityLevel.LOW: sum(1 for r in all_results if r.overall_queryability == QueryabilityLevel.LOW)
        }

        # ì „ì²´ ì¿¼ë¦¬ ê°€ëŠ¥ ë¹„ìœ¨ (HIGH + MEDIUM)
        queryable_count = queryability_counts[QueryabilityLevel.HIGH] + queryability_counts[QueryabilityLevel.MEDIUM]
        queryability_ratio = queryable_count / total_criteria if total_criteria > 0 else 0

        # ëª¨ë“  í…Œì´ë¸”ê³¼ ë ˆì‹œí”¼ ìˆ˜ì§‘
        all_tables = set()
        all_recipes = set()
        for result in all_results:
            all_tables.update(result.required_tables)
            all_recipes.update(result.recommended_recipes)

        analysis_summary = {
            "trial_name": trial_name,
            "total_criteria_count": total_criteria,
            "queryability_distribution": {
                "HIGH": queryability_counts[QueryabilityLevel.HIGH],
                "MEDIUM": queryability_counts[QueryabilityLevel.MEDIUM],
                "LOW": queryability_counts[QueryabilityLevel.LOW]
            },
            "overall_queryability_ratio": queryability_ratio,
            "inclusion_analysis": inclusion_results,
            "exclusion_analysis": exclusion_results,
            "required_databricks_tables": list(all_tables),
            "recommended_recipes": list(all_recipes),
            "analysis_summary": self._generate_analysis_summary(all_results)
        }

        return analysis_summary

    def _parse_llm_response(self, response_text: str) -> Dict[str, Any]:
        """LLM ì‘ë‹µ íŒŒì‹±"""
        try:
            # JSON ë¸”ë¡ ì°¾ê¸°
            json_match = re.search(r'\{.*\}', response_text, re.DOTALL)
            if json_match:
                json_str = json_match.group()
                return json.loads(json_str)
            else:
                print(f"âš ï¸ JSON í˜•íƒœë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: {response_text[:200]}...")
                return {}
        except json.JSONDecodeError as e:
            print(f"âš ï¸ JSON íŒŒì‹± ì˜¤ë¥˜: {e}")
            return {}
        except Exception as e:
            print(f"âš ï¸ ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜: {e}")
            return {}

    def _generate_analysis_summary(self, all_results: List[QueryableCriteriaResult]) -> Dict[str, Any]:
        """ë¶„ì„ ê²°ê³¼ ìš”ì•½ ìƒì„±"""

        # ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” í…Œì´ë¸”ë“¤
        table_counts = {}
        for result in all_results:
            for table in result.required_tables:
                table_counts[table] = table_counts.get(table, 0) + 1

        # ê°€ì¥ ë§ì´ ì¶”ì²œë˜ëŠ” ë ˆì‹œí”¼ë“¤
        recipe_counts = {}
        for result in all_results:
            for recipe in result.recommended_recipes:
                recipe_counts[recipe] = recipe_counts.get(recipe, 0) + 1

        # ê³µí†µ ë°ì´í„° ì œì•½ì‚¬í•­ë“¤
        limitation_counts = {}
        for result in all_results:
            for limitation in result.data_limitations:
                limitation_counts[limitation] = limitation_counts.get(limitation, 0) + 1

        return {
            "most_used_tables": sorted(table_counts.items(), key=lambda x: x[1], reverse=True)[:5],
            "most_recommended_recipes": sorted(recipe_counts.items(), key=lambda x: x[1], reverse=True)[:5],
            "common_limitations": sorted(limitation_counts.items(), key=lambda x: x[1], reverse=True)[:5],
            "average_confidence": sum(r.confidence_score for r in all_results) / len(all_results) if all_results else 0
        }

    def generate_report(self, analysis_result: Dict[str, Any]) -> str:
        """ë¶„ì„ ê²°ê³¼ ë³´ê³ ì„œ ìƒì„±"""

        report = f"""
ğŸ¥ ì„ìƒì‹œí—˜ ê¸°ì¤€ ì¿¼ë¦¬ ê²€ì¦ ê°€ëŠ¥ì„± ë¶„ì„ ë³´ê³ ì„œ
====================================================

ğŸ“‹ ì„ìƒì‹œí—˜ëª…: {analysis_result['trial_name']}

ğŸ“Š ì „ì²´ ìš”ì•½:
- ì´ ê¸°ì¤€ ìˆ˜: {analysis_result['total_criteria_count']}ê°œ
- ì¿¼ë¦¬ ê²€ì¦ ê°€ëŠ¥ë¥ : {analysis_result['overall_queryability_ratio']:.1%}

ğŸ“ˆ ê²€ì¦ ê°€ëŠ¥ì„± ë¶„í¬:
- HIGH (80%+ ê²€ì¦ê°€ëŠ¥): {analysis_result['queryability_distribution']['HIGH']}ê°œ
- MEDIUM (40-80% ê²€ì¦ê°€ëŠ¥): {analysis_result['queryability_distribution']['MEDIUM']}ê°œ
- LOW (40% ë¯¸ë§Œ): {analysis_result['queryability_distribution']['LOW']}ê°œ

ğŸ’½ í•„ìš”í•œ ë°ì´í„°ë¸Œë¦­ìŠ¤ í…Œì´ë¸”:
"""
        for table in analysis_result['required_databricks_tables']:
            report += f"â€¢ {table}\n"

        report += f"\nğŸ”§ ê¶Œì¥ ë ˆì‹œí”¼:"
        for recipe in analysis_result['recommended_recipes']:
            report += f"\nâ€¢ {recipe}"

        report += f"\n\nâœ… ì¿¼ë¦¬ ê²€ì¦ ê°€ëŠ¥í•œ ê¸°ì¤€ë“¤:\n"

        high_medium_criteria = [c for c in analysis_result['inclusion_analysis'] + analysis_result['exclusion_analysis']
                               if c.overall_queryability in [QueryabilityLevel.HIGH, QueryabilityLevel.MEDIUM]]

        for i, criteria in enumerate(high_medium_criteria, 1):
            report += f"\n{i}. [{criteria.overall_queryability.value}] {criteria.original_text[:80]}..."
            if criteria.queryable_parts:
                report += f"\n   âœ“ ê²€ì¦ê°€ëŠ¥: {', '.join(criteria.queryable_parts[:2])}..."

        report += f"\n\nğŸš« ì¿¼ë¦¬ ê²€ì¦ ì–´ë ¤ìš´ ê¸°ì¤€ë“¤:\n"

        low_criteria = [c for c in analysis_result['inclusion_analysis'] + analysis_result['exclusion_analysis']
                       if c.overall_queryability == QueryabilityLevel.LOW]

        for i, criteria in enumerate(low_criteria, 1):
            report += f"\n{i}. {criteria.original_text[:80]}..."
            if criteria.non_queryable_parts:
                report += f"\n   âœ— ì œì•½ì‚¬í•­: {', '.join(criteria.non_queryable_parts[:1])}"

        report += f"\n\nğŸ’¡ ì‹¤ë¬´ ê¶Œì¥ì‚¬í•­:"
        if analysis_result['overall_queryability_ratio'] >= 0.7:
            report += f"\nâ€¢ ë†’ì€ ê²€ì¦ ê°€ëŠ¥ë¥ ë¡œ ë°ì´í„° ê¸°ë°˜ ìŠ¤í¬ë¦¬ë‹ì— ì í•©"
        elif analysis_result['overall_queryability_ratio'] >= 0.4:
            report += f"\nâ€¢ ë¶€ë¶„ì  ê²€ì¦ ê°€ëŠ¥, ìˆ˜ë™ ê²€í† ì™€ ë³‘í–‰ ê¶Œì¥"
        else:
            report += f"\nâ€¢ ë‚®ì€ ê²€ì¦ ê°€ëŠ¥ë¥ , ìˆ˜ë™ ìŠ¤í¬ë¦¬ë‹ ìš°ì„  ê³ ë ¤"

        avg_confidence = analysis_result['analysis_summary']['average_confidence']
        report += f"\nâ€¢ í‰ê·  ë¶„ì„ ì‹ ë¢°ë„: {avg_confidence:.1%}"

        return report


# ì‚¬ìš© ì˜ˆì‹œ í•¨ìˆ˜
def analyze_trial_from_text(trial_name: str, inclusion_text: str, exclusion_text: str):
    """í…ìŠ¤íŠ¸ ì…ë ¥ìœ¼ë¡œë¶€í„° ì„ìƒì‹œí—˜ ê¸°ì¤€ ë¶„ì„ ì‹¤í–‰"""

    try:
        analyzer = QueryableCriteriaAnalyzer()
        result = analyzer.analyze_trial_criteria(trial_name, inclusion_text, exclusion_text)
        report = analyzer.generate_report(result)

        print(report)
        return result

    except Exception as e:
        print(f"âŒ ë¶„ì„ ì‹¤íŒ¨: {e}")
        return None


if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ
    sample_inclusion = """
    1. ë§Œ 19ì„¸ ì´ìƒ 75ì„¸ ì´í•˜ì˜ ì„±ì¸ ë‚¨ë…€
    2. ê³ í˜ˆì•• ì§„ë‹¨ì„ ë°›ê³  í˜„ì¬ í•­ê³ í˜ˆì••ì œë¥¼ ë³µìš© ì¤‘ì¸ í™˜ì
    3. ìµœê·¼ 6ê°œì›” ì´ë‚´ í˜ˆì••ì´ 140/90 mmHg ì´ìƒìœ¼ë¡œ ì¸¡ì •ëœ í™˜ì
    4. ì—°êµ¬ ì°¸ì—¬ì— ì„œë©´ ë™ì˜í•œ í™˜ì
    5. ì—°êµ¬ ê¸°ê°„ ì¤‘ ì§€ì†ì ì¸ ì¶”ì ê´€ì°°ì´ ê°€ëŠ¥í•œ í™˜ì
    """

    sample_exclusion = """
    1. ì„ì‹  ë˜ëŠ” ìˆ˜ìœ  ì¤‘ì¸ ì—¬ì„±
    2. ì‹¬ê°í•œ ê°„ê¸°ëŠ¥ ë˜ëŠ” ì‹ ê¸°ëŠ¥ ì¥ì• ê°€ ìˆëŠ” í™˜ì
    3. ìµœê·¼ 3ê°œì›” ì´ë‚´ ì‹¬ê·¼ê²½ìƒ‰ì´ë‚˜ ë‡Œì¡¸ì¤‘ ë³‘ë ¥ì´ ìˆëŠ” í™˜ì
    4. ì—°êµ¬ìê°€ ë¶€ì í•©í•˜ë‹¤ê³  íŒë‹¨í•˜ëŠ” í™˜ì
    5. ë‹¤ë¥¸ ì„ìƒì‹œí—˜ì— ì°¸ì—¬ ì¤‘ì¸ í™˜ì
    """

    analyze_trial_from_text("ê³ í˜ˆì•• ì‹ ì•½ íš¨ëŠ¥ í‰ê°€ ì—°êµ¬", sample_inclusion, sample_exclusion)